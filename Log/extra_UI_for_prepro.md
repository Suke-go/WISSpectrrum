# ローカル前処理フロントエンド実装要件

## 1. 全体方針
- スクレイピングやダウンロード機能は含めず、手元に用意済みの PDF 群と既存サマリー JSON を対象とする。
- 指定したディレクトリ配下の PDF を先頭から順に処理するバッチ UI を提供する。処理順や残数を把握できる簡易なキュー表示を用意する。
- 既存 CLI（`Pre-Processing/orchestrator.py` など）のオプションを UI から操作できるようにし、最終的には CLI を呼び出す構成を基本とする。

## 2. 入力対象と実行範囲の指定
- `PDF ディレクトリ選択`: ルートまたは複数ディレクトリを追加し、内部で `*.pdf` を自動列挙。
- `処理件数上限`: 先頭から何件処理するかを整数入力（未指定なら全件）。
- `既存 JSON 更新ポリシー`: 以下をトグルで選択
  - 既存 JSON があればスキップ
  - 強制的に再処理して上書き
  - 新規 JSON のみ生成（既存は触らない）
- `出力ディレクトリ`: サマリー JSON の保存先を選択。ディレクトリ構成は PDF ディレクトリに追従。

## 3. サマリー生成制御
- `サマリーを生成する / しない` のトグル（既存サマリーのみ再利用したいケースに対応）。
- `OpenAI モデル選択`: 既定値 `gpt-5-mini` のほか、OpenAI の `models` API を用いて利用可能モデルを検索・候補表示できるようにする（モデル ID のインクリメンタルサーチ対応）。
- `要約言語`: 例として `Japanese` / `English` などを選択可能に。
- `チャンク設定`: `chunk_size` と `overlap` を整数入力欄で指定。
- `LLM 温度・トークン上限`: `temperature`, `chunk_max_output`, `final_max_output` を数値調整できるようにする。
- `メタデータ抽出文字数`: `metadata_chars` を設定するフィールド。
- `追加プロンプト指示`: 各チャンク要約・最終統合プロンプトに追記する指示テキストを入力できるメモ欄を用意。既存プロンプトに追記する前提で CLI 側へ渡す（環境変数や一時ファイルなどで連携する想定）。
- `GROBID 使用トグル`: `pypdf` / `grobid` を切り替える UI。GROBID 使用時は `grobid_url` と `grobid_timeout` を設定可能にし、Docker コンテナのビルド済みイメージ有無と稼働ステータス（ヘルスチェック）を UI 上で確認できるようにする。

## 4. Embedding 計算制御
- `Embedding を生成する / しない` トグル。既存ベクトルがある場合の再計算ポリシー（スキップ / 強制再計算）を選択。
- `プロバイダ選択`: `local`, `vertex-ai`, `gemini` の切り替え。選択内容に応じて下記項目を表示。
  - `local`: モデル名 (`intfloat/multilingual-e5-large-instruct` など) と L2 正規化有無。
  - `vertex-ai`: プロジェクト ID, ロケーション, モデル名, 出力次元。
  - `gemini`: モデル名, タスクタイプ, API キー（キー未設定時のエラー表示も考慮）, バッチサイズ。
- `対象セクション選択`: `positioning`, `purpose`, `method`, `evaluation`, `abstract` のチェックボックス。指定なしの場合は全てを処理。
- `埋め込みバージョンタグ`: JSON 内の `embedding_version` を指定。
- `メタ情報表示`: 実行結果にベクトル次元・プロバイダ・処理時間などを UI 上で確認できるようにする。

## 5. CCS 分類制御
- `CCS 分類を実行する / しない` トグル。既存分類結果の再利用・再生成を切り替え。
- `分類モデル設定`: `ccs_model`, `ccs_max_concepts`, `ccs_top_candidates`, `ccs_fallback_candidates`, `ccs_temperature`, `ccs_max_output_tokens` を入力できるパネル。
- `タクソノミーパス選択`: `ccs_taxonomy_path` をファイルピッカーで指定し、読み込み可否を即時チェック。
- `埋め込みモデル指定`: `ccs_embedding_model` を選択し、`none` 指定時は埋め込みを行わない旨を確認表示。
- `結果プレビュー`: 推定された CCS パスとスコアを UI 上で確認し、再分類ボタンから対象ファイル単位で再実行できるようにする。

## 6. 再処理・部分処理サポート
- `再要約のみ再実行`: 既存 JSON を読み込み、指定した追加プロンプトで要約部分だけ更新するモード。
- `Embedding のみ刷新`: 既存サマリーをそのまま使い、埋め込みだけ再計算するモード（`Pre-Processing/compute_embeddings.py` のパラメータを転用）。
- `Dry-run`: 実際のファイル書き込みを行わずに予定処理内容を一覧表示。
- `実行ログ表示`: 現在の処理中ファイル・成功/失敗件数・エラーメッセージをモーダルまたはログペインで表示。

## 7. 認証・環境変数管理
- `.env` ファイルの参照先を指定するフィールドを用意し、必要な環境変数（`OPENAI_API_KEY`, `GEMINI_API_KEY`, `VERTEX_AI_PROJECT` 等）を事前チェック。未設定の場合は警告を表示。
- 実行前に環境変数を UI から上書き投入できるようにする（API キーの再入力や別環境との切替がしやすくなる）。

## 8. 実装メモ
- CLI 呼び出しはサブプロセス経由で行い、戻り値・標準出力を UI に反映。非同期実行と進捗更新をサポートする。
- 処理キューと結果一覧はローカル SQLite（`PipelineState`）または簡易的な JSON/メモリ管理を活用し、隊列の可視化を行う。
- エラー時は該当ファイルとメッセージを保存しておき、再実行対象に追加できるようにする。
- GROBID を用いる場合は Docker ビルド済みイメージの存在とコンテナ起動コマンド（例: `docker compose up grobid`）を UI から確認・案内できるようにし、ヘルスチェック失敗時には再起動操作を提示する。

## 9. 今後の拡張余地
- サマリー出力済み JSON を UI 上で表示・軽微な修正を行い、そのまま保存する簡易エディタ。
- サマリーと埋め込みの比較履歴（前回との差分やベクトル更新日）をメタ情報として提示。
- 処理済みファイルのフィルタリング（成功 / 失敗 / スキップ）と、手動での再キューイング操作。
